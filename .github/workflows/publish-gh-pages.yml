name: Publish GitHub Pages

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Specify the version number for documentation"
        required: true
        default: "latest"

jobs:
  publish:
    name: Publish GitHub pages
    needs: build
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0
        with:
          fetch-depth: 0 # To fetch all history for all branches and tags. (Will be required for caching with lerna: https://github.com/markuplint/markuplint/pull/111)

      - name: Use Node.js 20.x
        uses: actions/setup-node@1a4442cacd436585916779262731d5b162bc6ec7 # v3.8.2
        with:
          node-version: "20.x"
          registry-url: "https://registry.npmjs.org"

      - name: Use Python 3.x
        uses: actions/setup-python@b64ffcaf5b410884ad320a9cfac8866006a109aa # v4.8.0
        with:
          python-version: "3.x"

      - name: Pre-docs-Publish
        run: |
          yarn --skip-integrity-check --network-timeout 100000
          yarn docs
        env:
          NODE_OPTIONS: --max_old_space_size=14336
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # https://github.com/microsoft/vscode-ripgrep/issues/9

      - name: Publish GH Pages
        uses: peaceiris/actions-gh-pages@373f7f263a76c20808c831209c920827a82a2847 # v3.9.3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages
          force_orphan: true # will only keep latest commit on branch gh-pages
